{% extends '_base.html' %} {% load unicorn %}{% load static %} {% block header %}

<link rel="stylesheet" href="{% static 'css/index.css' %}" />

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
  integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
  integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
  crossorigin=""
></script>
<script type="text/javascript" src="{% static 'js/city.js' %}"></script>
<script type="text/javascript" src="{% static 'js/bairros.js' %}"></script>

<script src='https://unpkg.com/@turf/turf@6/turf.min.js'
crossorigin=""></script>


{% endblock %} {% block title %} Habitas {% endblock %} {% block content %}

<div class="grid grid-cols-4 my-4 scrollbar-thin scrollbar scrollbar-thumb-gray-300" style="overflow-y: auto;max-height: 100vh;">
  <div class="col-span-1 mx-2 px-6 items-center scrollbar-thin scrollbar scrollbar-thumb-gray-300 scrollbar-track-gray-100 bg-clip-content border h-[calc(93vh-90px)]" style="overflow-y: auto;max-height: 100vh;">
    <div class="flex flex-row justify-between my-2">
  <button id="tab-info" type="button" class="px-4 py-2 rounded bg-emerald-600 text-white" onclick="showSidebarTab('info')">Informações</button>
  <button id="tab-filter" type="button" class="px-4 py-2 rounded bg-gray-200 text-emerald-900" onclick="showSidebarTab('filter')">Filtros</button>
    </div>
  <div id="sidebar-filter" style="display:none;">
    <h1 class="text-3xl text-left font-bold my-2 w-fit">Árvores de SJC<hr class="bg-emerald-600 h-2.5 w-full my-2" /></h1>
    <form method="get" class="mb-4">
      <label class="block mb-4">Espécie:
        <select name="species" class="w-full border rounded px-2 py-2 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-gray-800">
          <option value="">Todas</option>
            {% for nome_popular in species_list %}
              <option value="{{ nome_popular|escape }}" {% if request.GET.species == nome_popular %}selected{% endif %}>{{ nome_popular|escape }}</option>
            {% endfor %}
        </select>
      </label>
      <label class="block mb-4">Origem:
        <select name="origem" class="w-full border rounded px-2 py-2 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-400 text-gray-800">
          <option value="">Todas</option>
          <option value="nativa" {% if request.GET.origem == 'nativa' %}selected{% endif %}>Nativa</option>
          <option value="exotica" {% if request.GET.origem == 'exotica' %}selected{% endif %}>Exótica</option>
          <option value="desconhecida" {% if request.GET.origem == 'desconhecida' %}selected{% endif %}>Desconhecida</option>
        </select>
      </label>
      <label class="block mb-4 flex items-center">
        <input type="checkbox" name="laudo_only" value="1" {% if request.GET.laudo_only %}checked{% endif %} class="mr-2" />
        Exibir apenas árvores com laudo
      </label>
      <div class="mb-4"></div>
        <label>Altura mínima (m):
          <div class="flex flex-row items-center gap-1">
            <input type="number" step="any" name="altura_min" value="{{ request.GET.altura_min }}" class="border rounded px-2 py-1" placeholder="Sem limite" />
            <button type="button" onclick="this.previousElementSibling.value='';" class="text-xs px-2 py-1 border rounded bg-gray-100">Limpar</button>
          </div>
        </label><br>
        <label>Altura máxima (m):
          <div class="flex flex-row items-center gap-1">
            <input type="number" step="any" name="altura_max" value="{{ request.GET.altura_max }}" class="border rounded px-2 py-1" placeholder="Sem limite" />
            <button type="button" onclick="this.previousElementSibling.value='';" class="text-xs px-2 py-1 border rounded bg-gray-100">Limpar</button>
          </div>
        </label><br>
        <label>DAP mínimo (cm):
          <div class="flex flex-row items-center gap-1">
            <input type="number" name="dap_min" value="{{ request.GET.dap_min }}" class="border rounded px-2 py-1" placeholder="Sem limite" />
            <button type="button" onclick="this.previousElementSibling.value='';" class="text-xs px-2 py-1 border rounded bg-gray-100">Limpar</button>
          </div>
        </label><br>
        <label>DAP máximo (cm):
          <div class="flex flex-row items-center gap-1">
            <input type="number" name="dap_max" value="{{ request.GET.dap_max }}" class="border rounded px-2 py-1" placeholder="Sem limite" />
            <button type="button" onclick="this.previousElementSibling.value='';" class="text-xs px-2 py-1 border rounded bg-gray-100">Limpar</button>
          </div>
        </label><br>
        <label>Plantado por:
        <div class="flex flex-row items-center gap-1">
          <input type="text" name="plantado_por" id="plantado_por_input" value="{{ request.GET.plantado_por }}" class="border rounded px-2 py-1" />
          <button type="button" onclick="document.getElementById('plantado_por_input').value = ''" class="text-xs px-2 py-1 border rounded bg-gray-100">Limpar</button>
        </div>
      </label><br>
      <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded mt-2">Filtrar</button>
    </form>
    </div>
  <div id="sidebar-info" style="display:block;">
      <h1 class="text-3xl text-left font-bold my-2 w-fit">Árvores de SJC<hr class="bg-emerald-600 h-2.5 w-full my-2" /></h1>
      <p class="text-left text-xl font-medium my-2">Aprenda sobre as árvores de sua vizinhança.</p>
      <p class="text-left font-light">Pela primeira vez, você tem acesso a informações sobre as árvores de São José dos Campos. Aprenda sobre as árvores que compõem a floresta urbana da nossa cidade.</p>
      <div class="mb-4">
        <button id="btn-reset-all" onclick="resetAllSelections()" class="hidden bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 font-medium transition-colors">
          <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Ver Todas as Árvores
        </button>
      </div>
      <h1 class="text-2xl text-left font-medium my-4 w-fit">Estatísticas gerais<hr class="bg-emerald-900 h-1.5 w-full" /></h1>
      <div class="grid grid-cols-3" id="estatisticas-gerais"></div>
      <h1 class="text-2xl text-left font-medium my-4 w-fit">Benefícios ecológicos<hr class="bg-emerald-900 h-1.5 w-full" /></h1>
      <div id="estatisticas-ecologicas"></div>
      <div id="estatisticas" style="display:none;">
        <h1 class="text-2xl text-left font-medium my-4 w-fit">Informações sobre a árvore<hr class="bg-emerald-900 h-1.5 w-full" /></h1>
        <h1 class="text-2xl text-left font-medium my-4 w-fit" id="nome_popular">
          <hr class="bg-emerald-900 h-1.5 w-full"/>
        </h1>
       <p class="text-left " id="dados">
        </p>
        <div id="acoes-container"></div> 
        <h2 class="text-2xl text-left font-medium my-4 w-fit">
          Comentários
          <hr class="bg-emerald-900 h-1.5 w-full" />
        </h2>
        {% unicorn 'posts' %}
      </div>
      <div class="info-container">
        <div class="info-header">Referências Científicas</div>
        {% for service in ecosystem_services %}
        <div>{{ service.nome }}: {{ service.referencia_cientifica|truncatewords:10 }}</div>
        {% endfor %}
      </div>
    </div>
    
  </div>
  <div class="z-0 col-span-3 pr-2 h-screen">
    <div id="map" class="z-0 min-w-max"></div>
    <div class="flex w-full h-max flex-row-reverse items-center my-4">
      <span class="text-emerald-600 font-serif flex flex-row">
        <img style="height: 28px;" src="{% static 'image/habitas.png' %}"><sup class="text-sm">®</sup>
        <span class="underline"></span>
      </span>
    </div>
  </div>
</div>

<script>
  // Show Informações tab by default on page load
  document.addEventListener('DOMContentLoaded', function() {
    showSidebarTab('info');
  });
  function showSidebarTab(tab) {
    const filterTab = document.getElementById('sidebar-filter');
    const infoTab = document.getElementById('sidebar-info');
    const btnFilter = document.getElementById('tab-filter');
    const btnInfo = document.getElementById('tab-info');
    if (tab === 'filter') {
      filterTab.style.display = 'block';
      infoTab.style.display = 'none';
      btnFilter.classList.add('bg-emerald-600', 'text-white');
      btnFilter.classList.remove('bg-gray-200', 'text-emerald-900');
      btnInfo.classList.add('bg-gray-200', 'text-emerald-900');
      btnInfo.classList.remove('bg-emerald-600', 'text-white');
    } else {
      filterTab.style.display = 'none';
      infoTab.style.display = 'block';
      btnInfo.classList.add('bg-emerald-600', 'text-white');
      btnInfo.classList.remove('bg-gray-200', 'text-emerald-900');
      btnFilter.classList.add('bg-gray-200', 'text-emerald-900');
      btnFilter.classList.remove('bg-emerald-600', 'text-white');
    }
  }
  // Serviços ecossistêmicos dinâmicos do BD
  const ecosystemServicesConfig = {
    {% for service in ecosystem_services %}
    '{{ service.codigo }}': {
      nome: '{{ service.nome }}',
      unidade: '{{ service.unidade_medida }}',
      valorMonetario: {{ service.valor_monetario_unitario }},
      categoria: '{{ service.categoria }}',
    },
    {% endfor %}
  };

  function renderStatisticsFromTree(tree) {
    // Renderiza estatísticas de uma única árvore
    const species = tree.nome_cientifico ? 1 : 0;
    const total_n_posts = tree.n_comentarios || 0;
    
    // Calcula serviços da árvore
    const servicesData = {};
    if (tree.services) {
      for (const [codigo, servico] of Object.entries(tree.services)) {
        const config = ecosystemServicesConfig[codigo];
        if (config) {
          const valorFisico = servico.valor_fisico || 0;
          const valorMonetario = servico.valor_monetario || (valorFisico * config.valorMonetario);
          
          servicesData[codigo] = {
            valorFisico: valorFisico,
            valorMonetario: valorMonetario,
            config: config
          };
        }
      }
    }
    
    renderStatisticsHTML(1, species, total_n_posts, servicesData);
  }

  function renderStatistics(circles) {
    // Filtra apenas círculos com dados de espécie carregados para estatísticas precisas
    const circlesWithSpecies = circles.filter(c => c.tree_species);
    const species = circlesWithSpecies.length > 0 
      ? new Set(circlesWithSpecies.map(a => a.tree_species)).size 
      : 0;
    const total_n_posts = circles.map(a => a.n_posts || 0).reduce((a,b)=>a+b, 0);
    
    // Calcula serviços dinamicamente apenas para círculos com dados completos
    const servicesData = {};
    for (const [codigo, config] of Object.entries(ecosystemServicesConfig)) {
      const values = circles.map(a => {
        // Busca valor no objeto tree que foi pre-calculado
        return a.services && a.services[codigo] ? a.services[codigo].valor_fisico : 0;
      });
      const total = values.reduce((a,b)=>a+b, 0);
      const valorMonetario = total * config.valorMonetario;
      
      servicesData[codigo] = {
        valorFisico: total,
        valorMonetario: valorMonetario,
        config: config
      };
    }
    
    renderStatisticsHTML(circles.length, species, total_n_posts, servicesData);
  }

  function renderStatisticsHTML(totalTrees, species, total_n_posts, servicesData) {

    document.getElementById("estatisticas-gerais").innerHTML = `
      <div class="my-2">
        <span class="font-bold text-xl">${totalTrees}</span>
        <br>
        <span class="text-lg">Árvores</span>
      </div>
      <div class="my-2">
        <span class="font-bold text-xl">${species}</span>
        <br>
        <span class="text-lg">Espécies</span>
      </div>
      <div class="my-2">
        <span class="font-bold text-xl">${total_n_posts}</span>
        <br>
        <span class="text-lg">Comentários</span>
      </div>
    `;

    // Gera HTML dinamicamente para todos os serviços
    let servicesHTML = '';
    for (const [codigo, data] of Object.entries(servicesData)) {
      const config = data.config;
      const valorFisico = data.valorFisico;
      const valorMonetario = data.valorMonetario;
      
      // Formatação baseada na unidade
      let valorFormatado = '';
      if (config.unidade.includes('ton') || config.unidade.includes('kg')) {
        valorFormatado = valorFisico.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      } else if (config.unidade.includes('L')) {
        valorFormatado = valorFisico.toLocaleString(undefined, {maximumFractionDigits: 0});
      } else if (config.unidade.includes('kWh')) {
        valorFormatado = valorFisico.toLocaleString(undefined, {maximumFractionDigits: 0});
      } else if (config.unidade.includes('g')) {
        valorFormatado = valorFisico.toLocaleString(undefined, {maximumFractionDigits: 2});
      } else {
        valorFormatado = valorFisico.toLocaleString(undefined, {maximumFractionDigits: 0});
      }
      
      servicesHTML += `
        <div class="my-2">
          <div class="font-bold text-xl">${config.nome}</div>
          <div style="display: grid; grid-auto-flow: column;">
            <span class="text-lg">${valorFormatado} <span style="color: rgb(5 150 105)">${config.unidade}</span></span>
            ${config.valorMonetario > 0 ? `<span class="text-lg"><span style="color: rgb(5 150 105)">Valor: </span>${valorMonetario.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} R$</span>` : ''}
          </div>
        </div>
      `;
    }
    
    document.getElementById("estatisticas-ecologicas").innerHTML = servicesHTML;
  }

  function create_google_maps_url(lat, long){
    return `http://maps.google.com/maps?z=12&t=m&q=loc:${lat}+${long}`
  }
  // load trees from context to list

  var map = L.map("map").setView([-23.205459913570404, -45.88184219354045], 15);

  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution:
      '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  }).addTo(map);

  function filterPointsInPolygon(polygon, circles) {
      // Check if both polygon and points are defined

      try {
          // Check if Turf.js is available and has the necessary functions
          if (typeof turf !== 'undefined' && turf.booleanPointInPolygon) {
              // Log the inputs for debugging

              // Filter points within the clicked neighborhood
              return circles.filter(circle => {
                  // Log the point for debugging
                  //console.log("Point:", point);

                  point = circle.toGeoJSON()

                  try {
                      // Check if the point has valid geometry and properties
                      const coordinates = point.geometry && point.geometry.coordinates;
                      //console.log("ok", coordinates, polygon.geometry.coordinates)

                      if (coordinates && Array.isArray(coordinates) && coordinates.length === 2) {

                          // Check if the coordinates are valid before invoking Turf.js
                          return turf.booleanPointInPolygon(turf.point(coordinates), turf.polygon(polygon.geometry.coordinates));
                      } else {
                          console.error("Invalid point:", point);
                          return false;
                      }
                  } catch (error) {
                      console.error("Error in filtering points:", error);
                      return false;
                  }
              });
          } else {
              console.error("Turf.js or its functions are not available.");
              return [];
          }
      } catch (error) {
          console.error("Error in filtering points:", error);
          return [];
      }
  }

  L.geoJSON(CITY_LIMIT, {fillOpacity: 0.0}).addTo(map);
  // Assume BAIRROS is a GeoJSON layer representing neighborhoods

  const neighborhoodsLayer = L.geoJSON(
    BAIRROS, {color: 'transparent'}
  ).addTo(map);

  let clickedLayerId = null;

  // Define a function to handle the click event on neighborhoods
  function highlightNeighborhood(e) {
    const clickedLayer = e.target;

    neighborhoodsLayer.getLayers().forEach((layer) => layer.unbindTooltip());
    circleLayerGroup.clearLayers();

    if (clickedLayer.feature.id === clickedLayerId) {
      // Desselecionar: volta a mostrar todas as árvores
      clickedLayer.setStyle({weight: 0,
        color: 'transparent',
        dashArray: '',
        fillOpacity: 0.0});
      
      // Adiciona todos os círculos de volta
      originalCircles.forEach(circle => {
        circleLayerGroup.addLayer(circle)
      });
      
      clickedLayerId = null;
      selectedNeighborhoodId = null;
      
      // Se há árvore selecionada, mostra só ela, senão mostra todas
      if (selectedTreeId) {
        const selectedCircle = originalCircles.find(c => c.tree_id === selectedTreeId);
        if (selectedCircle) {
          renderStatisticsFromTree(tree_map.get(selectedTreeId));
        } else {
          renderStatistics(originalCircles);
        }
      } else {
        renderStatistics(originalCircles);
      }
      
      updateResetButton();
    } else {
      // Selecionar bairro: mostra apenas árvores daquele bairro
      clickedLayer.bindTooltip(clickedLayer.feature.properties.bairro,  {permanent: true, direction: 'center', opacity: 0.5}).addTo(map);
      
      neighborhoodsLayer.resetStyle();
      clickedLayer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.4
      });
        
      const clickedNeighborhood = clickedLayer.toGeoJSON();
      const filteredCircles = filterPointsInPolygon(clickedNeighborhood, originalCircles);
  
      filteredCircles.forEach(circle => {
          circleLayerGroup.addLayer(circle)
      });

      clickedLayerId = clickedLayer.feature.id;
      selectedNeighborhoodId = clickedLayer.feature.id;
      
      // Esconde detalhes da árvore selecionada quando seleciona bairro
      if (selectedTreeId) {
        document.getElementById("estatisticas").style.display = "none";
        // Remove seleção visual da árvore
        if (lastClickedCircle) {
          lastClickedCircle.setStyle({
            color: tree_map.get(lastClickedCircle.tree_id).color,
            fillColor: tree_map.get(lastClickedCircle.tree_id).color
          });
          lastClickedCircle = null;
        }
        selectedTreeId = null;
      }

      // Carrega dados das árvores do bairro antes de renderizar estatísticas
      async function loadNeighborhoodData() {
        const loadPromises = filteredCircles.map(async (circle) => {
          if (!circle.services) {
            await loadTreeData(circle.tree_id);
          }
        });
        await Promise.all(loadPromises);
        renderStatistics(filteredCircles);
      }
      
      loadNeighborhoodData();
      updateResetButton();
    }
    
    circleLayerGroup.addTo(map);
  }

  neighborhoodsLayer.eachLayer(layer => {
      layer.on('click', highlightNeighborhood);
  });

  async function loadTreeData(tree_id) {
    // Verifica se os dados já foram carregados
    const tree = tree_map.get(tree_id);
    if (tree && tree.loaded) {
      return tree;
    }

    // Carrega dados completos via API
    try {
      const response = await fetch(`/api/tree/${tree_id}/`);
      if (!response.ok) {
        throw new Error('Erro ao carregar dados da árvore');
      }
      const treeData = await response.json();
      
      // Atualiza o tree_map com dados completos
      const updatedTree = {
        ...tree,
        ...treeData,
        imagens: treeData.imagens || [],
        laudos: treeData.laudos || [],
        loaded: true
      };
      tree_map.set(tree_id, updatedTree);
      
      // Atualiza o círculo com informações adicionais se necessário
      const circle = originalCircles.find(c => c.tree_id === tree_id);
      if (circle) {
        circle.tree_species = updatedTree.nome_cientifico;
        circle.n_posts = updatedTree.n_comentarios;
        circle.services = updatedTree.services;
        if (updatedTree.services) {
          circle.stored_co2 = updatedTree.services['co2_armazenado'] ? updatedTree.services['co2_armazenado'].valor_fisico : updatedTree.co2;
          circle.stormwater_intercepted = updatedTree.services['chuva_interceptada'] ? updatedTree.services['chuva_interceptada'].valor_fisico : updatedTree.stormwater;
          circle.conserved_energy = updatedTree.services['energia_conservada'] ? updatedTree.services['energia_conservada'].valor_fisico : updatedTree.conserved_energy;
          circle.biodiversity = updatedTree.services['biodiversidade'] ? updatedTree.services['biodiversidade'].valor_fisico : updatedTree.biodiversity;
        }
      }
      
      return updatedTree;
    } catch (error) {
      console.error('Erro ao carregar dados da árvore:', error);
      return tree; // Retorna dados básicos em caso de erro
    }
  }

  function updateResetButton() {
    const btnReset = document.getElementById("btn-reset-all");
    if (selectedTreeId || selectedNeighborhoodId) {
      btnReset.classList.remove("hidden");
    } else {
      btnReset.classList.add("hidden");
    }
  }

  function resetAllSelections() {
    // Remove seleção de bairro
    if (selectedNeighborhoodId) {
      neighborhoodsLayer.getLayers().forEach((layer) => {
        if (layer.feature.id === selectedNeighborhoodId) {
          layer.setStyle({weight: 0, color: 'transparent', dashArray: '', fillOpacity: 0.0});
          layer.unbindTooltip();
        }
      });
      clickedLayerId = null;
      selectedNeighborhoodId = null;
    }
    
    // Remove seleção de árvore
    if (lastClickedCircle) {
      lastClickedCircle.setStyle({
        color: tree_map.get(lastClickedCircle.tree_id).color,
        fillColor: tree_map.get(lastClickedCircle.tree_id).color
      });
      lastClickedCircle = null;
    }
    
    selectedTreeId = null;
    document.getElementById("estatisticas").style.display = "none";
    
    // Mostra todas as árvores
    circleLayerGroup.clearLayers();
    originalCircles.forEach(circle => {
      circleLayerGroup.addLayer(circle)
    });
    circleLayerGroup.addTo(map);
    
    // Atualiza estatísticas para todas as árvores
    // Como os círculos podem não ter serviços carregados inicialmente,
    // renderStatistics vai calcular com os dados disponíveis (que serão 0 para serviços não carregados)
    // Isso está correto porque inicialmente só carregamos posições
    renderStatistics(originalCircles);
    updateResetButton();
  }

  async function onMapClick(index) {
    // Carrega dados completos se necessário
    const tree = await loadTreeData(index);
    
    selectedTreeId = index;
    
    // Se há bairro selecionado, remove a seleção do bairro
    if (selectedNeighborhoodId) {
      neighborhoodsLayer.getLayers().forEach((layer) => {
        if (layer.feature.id === selectedNeighborhoodId) {
          layer.setStyle({weight: 0, color: 'transparent', dashArray: '', fillOpacity: 0.0});
          layer.unbindTooltip();
        }
      });
      clickedLayerId = null;
      selectedNeighborhoodId = null;
      
      // Mostra todas as árvores novamente
      circleLayerGroup.clearLayers();
      originalCircles.forEach(circle => {
        circleLayerGroup.addLayer(circle)
      });
      circleLayerGroup.addTo(map);
    }
    
    // Atualiza estatísticas de cima com dados da árvore selecionada
    renderStatisticsFromTree(tree);
    
    Unicorn.call("posts", "update", tree.id);
    updateResetButton();
    let img_links = [];
    for (let i = 0; i < (tree.imagens || []).length; i++) {
      img_links.push(`<img src="https://arvores.sjc.sp.gov.br${tree.imagens[i]}">`);
    }
    let laudos = [];
    for (let i = 0; i < (tree.laudos || []).length; i++) {
      laudos.push(`<a href="https://arvores.sjc.sp.gov.br${tree.laudos[i]}" class="underline text-blue-500">Laudo ${i + 1}</a>`);
    }
    google_maps_url = create_google_maps_url(tree.latitude, tree.longitude);

    // Criar botões de ação baseado no tipo de usuário
    let acoesBotoes = '';
    {% if user.is_authenticated %}
      acoesBotoes = '<div class="mt-4 flex flex-col space-y-2">'; // Usar flex-col para empilhar
      
      {% if user.is_tecnico or user.is_gestor %}
      acoesBotoes += `
          <a href="/laudos/criar/${tree.id}/" class="inline-flex items-center justify-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 font-medium transition-colors shadow-md">
              <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <span class="whitespace-nowrap">Criar Laudo Técnico</span>
          </a>
      `;
      {% endif %}
      
      acoesBotoes += `
          <a href="/notificacoes/criar/${tree.id}/" class="inline-flex items-center justify-center gap-2 bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 font-medium transition-colors shadow-md">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <span class="whitespace-nowrap">Criar Notificação</span>
          </a>
      `;
      
      acoesBotoes += '</div>';
    {% endif %}

    document.getElementById("estatisticas").style.display = "block";
    
    // Preenche os dados da árvore (sem serviços ecossistêmicos, já estão em cima)
    document.getElementById("dados").innerHTML = `
      <p>Id. da árvore: ${tree.numero}</p>
      <p>Nome científico: ${tree.nome_cientifico}</p>
      <p>Diâmetro: ${tree.dap} cm</p>
      <p>Altura: ${tree.altura} m</p>
      <p>Google maps: <a href="${google_maps_url}" class="underline text-blue-500">link</a></p>
      <p>Plantado por: ${tree.plantado_por } </p>
      ${laudos.length > 0 ? `<p>Laudos: ${laudos.join(', ')} </p>` : ""}
      ${img_links.length > 0 ? `<p style="font-weight: bold;">Imagens</p> ${img_links.join('')}` : ""}
    `;

    // ATUALIZAÇÃO 2: Preenche o novo <div> APENAS com os botões
    document.getElementById("acoes-container").innerHTML = acoesBotoes;

    document.getElementById("nome_popular").innerHTML = `${tree.nome_popular}`;
  }

  tree_map = new Map();

  // Otimização: carrega apenas posições inicialmente
  {% for tree in trees %}
    tree_obj = {
      id: {{ tree.id }},
      latitude: {{ tree.latitude }},
      longitude: {{ tree.longitude }},
      n_comentarios: {{ tree.n_posts }},
      color: {{ tree.n_posts }} > 0 ? "yellow" : "green",
      loaded: false  // Flag para indicar se os dados completos foram carregados
    };

    tree_map.set(tree_obj.id, tree_obj)
  {% endfor %}


  // circle_map = new Map();
  let lastClickedCircle;
  const circleLayerGroup = L.layerGroup();
  const originalCircles = []
  
  // Estado de seleção
  let selectedTreeId = null;
  let selectedNeighborhoodId = null;

  for (let [tree_id, tree] of tree_map) {
    circle = L.circle(
      [tree.latitude, tree.longitude],
      {
        color: tree.color,
        fillColor: tree.color,
        fillOpacity: 0.5,
        radius: 5,
        selected: false,
      }
    )
    circle.tree_id = tree_id;
    circle.tree_species = tree.nome_cientifico || '';  // Será atualizado quando carregar dados completos
    circle.n_posts = tree.n_comentarios;
    // Serviços serão carregados sob demanda
    circle.services = null;
    circle.stored_co2 = 0;
    circle.stormwater_intercepted = 0;
    circle.conserved_energy = 0;
    circle.biodiversity = 0;

    circle.on("click", async function(){
      if (lastClickedCircle){
        lastClickedCircle.setStyle({
          color: tree_map.get(lastClickedCircle.tree_id).color,
          fillColor: tree_map.get(lastClickedCircle.tree_id).color
        });
      }

      await onMapClick(tree_id);
      lastClickedCircle = this;
      this.setStyle({color: 'red', fillColor: '#f00'});
    })

    originalCircles.push(circle)
  }

  // Adiciona todos os círculos ao mapa inicialmente
  originalCircles.forEach(circle => circleLayerGroup.addLayer(circle));
  circleLayerGroup.addTo(map);

  renderStatistics(originalCircles);
</script>

{% endblock %}
